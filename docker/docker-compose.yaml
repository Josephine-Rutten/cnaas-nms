version: '3.7'
services:

  #
  # CNaaS services
  #
  
  cnaas_api:
    build: ./api/
    ports:
      - 443:1443
    networks:
      - cnaas

    environment:
      # These envronment variables are hard-coded here for testing
      # purposes. If you intend to run this is in production, please
      # remove the usernames and password and pass them as environment
      # variables when starting the containers.
      - GITREPO_TEMPLATES
      - GITREPO_SETTINGS
      - COVERAGE
      - USERNAME_DHCP_BOOT=admin
      - PASSWORD_DHCP_BOOT=abc123abc123
      - USERNAME_DISCOVERED=admin
      - PASSWORD_DISCOVERED=abc123abc123
      - USERNAME_INIT=admin
      - PASSWORD_INIT=abc123abc123
      - USERNAME_MANAGED=admin
      - PASSWORD_MANAGED=abc123abc123
    depends_on:
      - "cnaas_postgres"
      - "cnaas_mongo"
      - "cnaas_redis"
      - "cnaas_httpd"
    volumes:
      - type: bind
        source: ./coverage
        target: /coverage

  cnaas_httpd:
    image:
      docker.sunet.se/cnaas/httpd
    ports:
      - 80:80
    networks:
      - cnaas
    environment:
      - GITREPO_TEMPLATES
  cnaas_dhcpd:
    build: ./dhcpd/
    ports:
      - 67:67/udp
    networks:
      - cnaas
    environment:
      - GITREPO_ETC
      - DB_PASSWORD=cnaas
      - DB_HOSTNAME=docker_cnaas_postgres_1
    depends_on:
      - "cnaas_httpd"
      - "cnaas_api"


  #
  # Databases
  #
  
  cnaas_postgres:
    build: ./postgres/
    ports:
      - 5432:5432
    environment:
      - POSTGRES_USER=cnaas
      - POSTGRES_PASSWD=cnaas
      - POSTGRES_DB=cnaas
    networks:
      - cnaas
  
  cnaas_mongo:
    build: ./mongo/
    volumes:
      - /opt/cnaas/mongodb/data:/data
    ports:
      - 27017:27017
    environment:
      - POSTGRES_USER=cnaas
      - POSTGRES_PASSWD=cnaas
      - POSTGRES_DB=cnaas
    networks:
      - cnaas

  cnaas_redis:
    build: ./redis/
    ports:
      - 6379:6379
    networks:
      - cnaas

networks:
  cnaas:
    driver: bridge
    name: cnaas
    ipam:
      config:
      - subnet: 172.18.0.0/24
    driver_opts:
      com.docker.network.bridge.name: br-cnaas
